---
title: "Files"
output: html_document
---

```{r}
files <- list.files(path = file.path(getwd(), "data"))
```
Zad. 1
```{r}
r <- 0.05
n <- 10
K <- 1000
# 1. Wysokość oprocentowania miesięcznego q
q <- 1 + r/12
# 2. Wysokość raty miesięcznej R
R <- K * q^n * (q-1)/(q^n - 1); R
# 3. Całkowita kwota do spłaty F
F <- R * n; F
# Wyświetlanie wyników
cat("Miesięczne oprocentowanie (q):", q, "\n")
cat("Miesięczna rata (R):", R, "\n")
cat("Całkowita kwota do spłaty (F):", F, "\n")
```
Zad. 2
```{r}
i <- 1:n
# 1. Wysokość części kapitałowej raty R0
R0 <- K/n
# 2. Wysokość części odsetkowej raty i-tej Ri1
Ri1 <- ((K-(i-1)*R0)*r)/12; Ri1
# 3. Wysokość raty i-tej Ri
Ri = R0 + Ri1; Ri
# 4. Całkowita kwotę do spłaty Fc
Fc = sum(Ri); Fc
# Najniższa, średnia i najwyższa wartość raty:
Fc_min = min(Ri)
Fc_mean = mean(Ri)
Fc_max = max(Ri)
```
Zad. 3
```{r}
wig <- readRDS('wig_changes.rds'); wig
head(wig)
table(wig)
?table()
prev_state <- wig[-length(wig)]   # dzień-1 (bez ostatniego)
next_state <- wig[-1]             # dzień (bez pierwszego)
prev_state <- factor(prev_state, levels = c("+", "-"))
next_state <- factor(next_state, levels = c("+", "-"))
transitions <- table(prev_state, next_state)
transitions
P <- prop.table(transitions, margin = 1)
P
P3 <- P %*% P %*% P    # macierzowo, suma wierszy przy prawdopodobieństwie równa 1
P3
```

Zad. 4a
```{r}
# Parametry założone
N <- 100    # początkowa liczba klientów
K <- 10     # wysokość składki
F <- 500    # wysokość odszkodowania
T <- 12     # okres symulacji (miesiące)

# Przygotowanie struktur do zapisywania wyników
S_historia <- numeric(T)  # Historia rezerw
N_historia <- numeric(T)  # Historia liczby klientów
bankructwo <- FALSE

# 1. Przyjmij t = 1
t <- 1

# 7. Pętla realizująca przejście t <= T
while (t <= T) {
  
  # 2. Wyznacz rezerwę na wypłaty St
  if (t == 1) {
    St <- K * N
  } else {
    # St_poprzednie to wartość rezerwy po wszystkich operacjach z poprzedniego miesiąca
    St <- St_poprzednie + K * N
  }
  
  # 3.: Wyznacz liczbę wypłat 'a'
  threshold <- qt(0.9999, df = 2) # kwantyl z treści zadania
  c_n <- rt(N, df = 2)           # losowanie dla każdego z N klientów
  a <- sum(c_n >= threshold)
  
  # 4. Wypłać odszkodowania
  St <- St - a * F
  
  # 5. Sprawdź płynność
  if (St >= 0) {
    # 5.1: Jeżeli spełnione, zmodyfikuj liczbę ubezpieczonych
    n <- sample(0:100, 1)        # nowi klienci
    o <- sample(0:90, 1)         # rezygnujący
    
    # Aktualizacja N: obecni + nowi - rezygnujący - ci co dostali wypłatę
    N <- max(0, N + n - o - a)
    
    # Zapisujemy stany do historii
    S_historia[t] <- St
    N_historia[t] <- N
    St_poprzednie <- St # zapamiętujemy stan kasy na początek kolejnego miesiąca
    
  } else {
    # 5.2: Jeżeli nie spełnione, firma zbankrutowała
    S_historia[t] <- St
    cat("Firma zbankrutowała w miesiącu:", t, "\n")
    bankructwo <- TRUE
    break # Zatrzymanie algorytmu przed czasem
  }
  
  # 6. Przyjmij t = t + 1
  t <- t + 1
}

# Podsumowanie
if (!bankructwo) {
  cat("Symulacja zakończona sukcesem po", T, "miesiącach.\n")
}

# Wyniki w formie tabeli dla przejrzystości (tylko dla miesięcy, które się odbyły)
wyniki <- data.frame(
  Miesiac = 1:min(t, T),
  Rezerwa_St = S_historia[1:min(t, T)],
  Liczba_Klientow = N_historia[1:min(t, T)]
)
print(wyniki)
```