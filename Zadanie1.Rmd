---
title: "Files"
output: html_document
---

```{r}
files <- list.files(path = file.path(getwd(), "data"))
```
Zad. 1
```{r}
r <- 0.05
n <- 10
K <- 1000
# 1. Wysokość oprocentowania miesięcznego q
q <- 1 + r/12
# 2. Wysokość raty miesięcznej R
R <- K * q^n * (q-1)/(q^n - 1); R
# 3. Całkowita kwota do spłaty F
F <- R * n; F
# Wyświetlanie wyników
cat("Miesięczne oprocentowanie (q):", q, "\n")
cat("Miesięczna rata (R):", R, "\n")
cat("Całkowita kwota do spłaty (F):", F, "\n")
```
Zad. 2
```{r}
i <- 1:n
# 1. Wysokość części kapitałowej raty R0
R0 <- K/n
# 2. Wysokość części odsetkowej raty i-tej Ri1
Ri1 <- ((K-(i-1)*R0)*r)/12; Ri1
# 3. Wysokość raty i-tej Ri
Ri = R0 + Ri1; Ri
# 4. Całkowita kwotę do spłaty Fc
Fc = sum(Ri); Fc
# Najniższa, średnia i najwyższa wartość raty:
Fc_min = min(Ri)
Fc_mean = mean(Ri)
Fc_max = max(Ri)
```
Zad. 3
```{r}
wig <- readRDS('wig_changes.rds'); wig
head(wig)
table(wig)
?table()
prev_state <- wig[-length(wig)]   # dzień-1 (bez ostatniego)
next_state <- wig[-1]             # dzień (bez pierwszego)
prev_state <- factor(prev_state, levels = c("+", "-"))
next_state <- factor(next_state, levels = c("+", "-"))
transitions <- table(prev_state, next_state)
transitions
P <- prop.table(transitions, margin = 1)
P
P3 <- P %*% P %*% P    # macierzowo, suma wierszy przy prawdopodobieństwie równa 1
P3
```

Zad. 4a
```{r}
# Parametry założone
N <- 100    # początkowa liczba klientów
K <- 10     # wysokość składki
F <- 500    # wysokość odszkodowania
T <- 12     # okres symulacji (miesiące)

# Przygotowanie struktur do zapisywania wyników
S_historia <- numeric(T)  # Historia rezerw
N_historia <- numeric(T)  # Historia liczby klientów
bankructwo <- FALSE

# 1. Przyjmij t = 1
t <- 1

# 7. Pętla realizująca przejście t <= T
while (t <= T) {
  
  # 2. Wyznacz rezerwę na wypłaty St
  if (t == 1) {
    St <- K * N
  } else {
    # St_poprzednie to wartość rezerwy po wszystkich operacjach z poprzedniego miesiąca
    St <- St_poprzednie + K * N
  }
  
  # 3.: Wyznacz liczbę wypłat 'a'
  threshold <- qt(0.9999, df = 2) # kwantyl z treści zadania
  c_n <- rt(N, df = 2)           # losowanie dla każdego z N klientów
  a <- sum(c_n >= threshold)
  
  # 4. Wypłać odszkodowania
  St <- St - a * F
  
  # 5. Sprawdź płynność
  if (St >= 0) {
    # 5.1: Jeżeli spełnione, zmodyfikuj liczbę ubezpieczonych
    n <- sample(0:100, 1)        # nowi klienci
    o <- sample(0:90, 1)         # rezygnujący
    
    # Aktualizacja N: obecni + nowi - rezygnujący - ci co dostali wypłatę
    N <- max(0, N + n - o - a)
    
    # Zapisujemy stany do historii
    S_historia[t] <- St
    N_historia[t] <- N
    St_poprzednie <- St # zapamiętujemy stan kasy na początek kolejnego miesiąca
    
  } else {
    # 5.2: Jeżeli nie spełnione, firma zbankrutowała
    S_historia[t] <- St
    cat("Firma zbankrutowała w miesiącu:", t, "\n")
    bankructwo <- TRUE
    break # Zatrzymanie algorytmu przed czasem
  }
  
  # 6. Przyjmij t = t + 1
  t <- t + 1
}

# Podsumowanie
if (!bankructwo) {
  cat("Symulacja zakończona sukcesem po", T, "miesiącach.\n")
}

# Wyniki w formie tabeli dla przejrzystości (tylko dla miesięcy, które się odbyły)
wyniki <- data.frame(
  Miesiac = 1:min(t, T),
  Rezerwa_St = S_historia[1:min(t, T)],
  Liczba_Klientow = N_historia[1:min(t, T)]
)
print(wyniki)
```
Zad. 4b
```{r}
# 1. Funkcja symulacji ubezpieczenia
  N0 <- 100   # początkowa liczba klientów
  K <- 10    # składka
  F <- 500   # odszkodowanie
  T <- 12     # liczba miesięcy

symulacja_ubezpieczenia <- function(N, K, F, T) {
  
  S_historia <- numeric(T)
  N_historia <- numeric(T)
  
  St_poprzednie <- 0
  
  for (t in 1:T) {
    
    # 2. Rezerwa przed wypłatami
    if (t == 1) {
      St <- K * N
    } else {
      St <- St_poprzednie + K * N
    }
    
    # 3. Liczba wypłat a
    threshold <- qt(0.9999, df = 2)
    c_n <- rt(N, df = 2)
    a <- sum(c_n >= threshold)
    
    # 4. Wypłaty
    St <- St - a * F
    
    # 5. Sprawdzenie płynności
    if (St < 0) {
      S_historia[t:T] <- NA
      break
    }
    
    # 5.1 Zmiana liczby klientów
    n <- sample(0:100, 1)
    o <- sample(0:90, 1)
    N <- max(0, N + n - o - a)
    
    # Zapis
    S_historia[t] <- St
    N_historia[t] <- N
    St_poprzednie <- St
  }
  
  return(S_historia)
}

# Wywołanie
symulacja_ubezpieczenia(N0, K, F, T)

# 2. Macierz SIM
M <- 10
T <- 12

SIM <- matrix(NA, nrow = M, ncol = T)

for (m in 1:M) {
  SIM[m, ] <- symulacja_ubezpieczenia(N0, K, F, T)
}; SIM

# 3.1 Prawdopodobieństwo, że spółka nie zbankrutuje do chwili t
p_survival <- numeric(T)

# SIM[, t] – rezerwy w miesiącu t
# !is.na() – firma nie zbankrutowała

for (t in 1:T) {
  p_survival[t] <- mean(!is.na(SIM[, t]))
}

p_survival

# 3.2 Średni poziom rezerw pod warunkiem braku bankructwa
mean_reserves <- numeric(T)

for (t in 1:T) {
  mean_reserves[t] <- mean(SIM[, t], na.rm = TRUE)
}

mean_reserves

# 3.3 Oczekiwany okres życia spółki (max T)
czas_zycia <- numeric(M)

for (m in 1:M) {
  if (any(is.na(SIM[m, ]))) {
    czas_zycia[m] <- which(is.na(SIM[m, ]))[1] - 1
  } else {
    czas_zycia[m] <- T
  }
}

mean(czas_zycia)
```
Zad. 5
```{r}
wiek_k <- readRDS('age.rds')
# 1. Najmłodszy i najstarszy klient
# sum(is.na(wiek_k)) #53 klientów - brak danych
najmlodszy <- min(wiek_k, na.rm = TRUE); najmlodszy
najstarszy <- max(wiek_k, na.rm = TRUE); najstarszy
cat("Najmłodszy klient ma",najmlodszy,", a najstarszy",najstarszy,"lat.")
# 2. Przeciętny wiek
sr_wiek <- round(mean(wiek_k, na.rm = TRUE)); sr_wiek
cat("Przeciętny wiek klienta banku to",sr_wiek,"lat.")
# 3. Zróżnicowanie wieku klientów
odchylenie <- round(sd(wiek_k, na.rm = TRUE)); odchylenie
cat("Zróżnicowanie klientów banku pod względem wieku (zostało opisane za pomocą (obliczone jako odchylenie standardowe) wynosi około",odchylenie,"lat.")
# 4. Ilu klientów jest niepełnoletnich i jaki to % całości?
niepelnoletni <- sum(wiek_k < 18, na.rm = TRUE); niepelnoletni
wszyscy <- length(wiek_k)
odsetek_niepelnoletnich <- (niepelnoletni / wszyscy*100); odsetek_niepelnoletnich
cat("Klientów niepełnoletnich jest",niepelnoletni,"i stanowi to",odsetek_niepelnoletnich,"%.")
# 5. Ilu klientów jest w wieku 30-50 lat i jaki to % całości?
wiek_30_50 <- sum(wiek_k > 30 & wiek_k < 50, na.rm = TRUE); wiek_30_50
odsetek_30_50 <- wiek_30_50 / wszyscy *100; odsetek_30_50
cat("Klientów w wieku miedży 30 a 50 lat jest",wiek_30_50," co stanowi",odsetek_30_50,"%.")
# 6 Ilu klientów nie podało wieku i jaki to % całości?
wiek_na <- sum(is.na(wiek_k)); wiek_na
odsetek_na <- wiek_na / wszyscy *100; odsetek_na
cat("Klientów którzy nie podali wieku jest",wiek_na,"co stanowi",odsetek_na,"%.")
```